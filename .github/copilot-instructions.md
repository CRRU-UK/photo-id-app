## Overview

- The Photo ID app is a research tool that can be used for photo-identification methodologies for longitudinal mark-recapture studies. It allows for the organisation and matching of photographs containing unique identification markings (such as cetacean dorsal fins). It includes tools for editing and visually filtering photographs to help with identification of marks.
- It is NOT a cataloguing tool, but a tool to group photos and edit them to more easily see indentifiable marks. These photos can then be exported and used in external cataloguing software.

## High-level architecture

- Main process: `src/main.ts` — app boot, `BrowserWindow` management, `ipcMain` handlers.
- Preload bridge: `src/preload.ts` — exposes `window.electronAPI` to renderer (use these methods from frontend).
- Renderer (UI): `src/index.tsx` and `src/frontend/**` — React + TanStack Router routes are generated into `src/routeTree.gen.ts` (do not edit).
- Backend helpers (file I/O, thumbnails, project logic): `src/backend/*.ts` called by the main process.

## Key files and patterns

- IPC event constants: `src/constants.ts` defines `IPC_EVENTS`. Use these names when linking main/preload/renderer behaviour.
- Preload API: call `window.electronAPI.*` from React. Example: `await window.electronAPI.savePhotoFile(data, arrayBuffer)` — handled in `src/main.ts` via `ipcMain.handle(IPC_EVENTS.SAVE_PHOTO_FILE, ...)`.
- Edit window flow: the main process opens edit windows by encoding JSON with `btoa` into the URL query (`?data=${btoa(JSON.stringify(data))}`) in `src/main.ts`; the edit route decodes with `atob` in `src/routes/edit.tsx`.
- Generated routes: `src/routeTree.gen.ts` is autogenerated by TanStack Router — do not modify it directly; edit files in `src/routes/` instead.
- Types: central types live in `src/types.ts` — use these for consistent shapes between main and renderer.

## Build / dev / test

### Required Before Each Commit

- Run `npm test` before committing any changes to ensure:
  - Linting passes (`eslint` + `prettier`)
  - Type-checking passes (`tsc --noEmit`)
  - All unit tests pass (`vitest run`)
- This ensures all code changes meet quality and consistency standards

### Development Flow

- **Prerequisites**: Node >= 24 required (see `README.md`)
- **Install dependencies**: `npm ci`
- **Run locally**: `npm start` (uses `electron-forge start`)
- **Run tests**: `npm test` (includes linting, type-check, and unit tests)
- **Run tests in watch mode**: `npm run test:unit:watch` for iterative development
- **Never run**: `npm run package`, `npm run make`, or `npm run publish`

## Conventions

### Code standards and style

- Prefer using constants when appropriate (see `src/constants.ts`).
- Prefer abstracting small blocks of logic into helper functions (see `src/helpers.ts`).
- Prefer using full variable and parameter names for clarity (e.g. `error` instead of `e`).
- Prefer using longer functions that are easier to read over clever one-liners.
- Prefer using async/await over raw Promises for async code.
- Prefer using `try/catch` for error handling over `.catch()` on Promises.
- Prefer using long math expressions broken over multiple lines for readability and shorthand assignments (e.g. `a = a + b` instead of `a += b`).
- Prefer adding comments only for workarounds, hacks, or non-obvious code paths.
- The UI uses GitHub Primer components/icons — prefer reusing Primer primitives and icons for consistency.

### Architecture-specific conventions

- IPC naming is explicit. Prefer using the `IPC_EVENTS` enum from `src/constants.ts` instead of raw strings.
- File operations and project persistence happen on the main side (`src/backend/*.ts`). Frontend should call preload helpers and assume I/O is async.
- Edit-window lifecycle: when navigating editor photos, the renderer calls `window.electronAPI.navigateEditorPhoto(data, direction)` which returns a base64-encoded JSON string that the edit route sets back into its query param.
- Thumbnails and edits are stored next to the project: see constants `PROJECT_EDITS_DIRECTORY` and `PROJECT_THUMBNAIL_DIRECTORY` in `src/constants.ts`.
- Avoid editing generated files: `src/routeTree.gen.ts` and other generator outputs.

## Integration points / external deps

- Electron + electron-forge + vite: packaging handled by `electron-forge` + forge Vite plugin (configs at project root: `vite.*.mts`, `forge.config.ts`).
- Sentry: integrated in both main (`@sentry/electron`) and renderer (`@sentry/electron/renderer`). Environment variables: `VITE_SENTRY_DSN` (renderer) and `SENTRY_DSN` (main). See `.env.example`.
- Native image processing: `sharp` is used in backend image helpers.

## If you need to change behaviour

- For IPC additions: add a new `IPC_EVENTS` entry, implement handler in `src/main.ts` (or backend helper) and expose through `src/preload.ts`.
- For UI routes: add/edit files in `src/routes/` — the generated `routeTree.gen.ts` will be updated by the router tooling.

When unsure, look at these files first

- `src/main.ts`
- `src/preload.ts`
- `src/index.tsx`
- `src/constants.ts`
- `src/types.ts`
- `src/backend/*`
- `src/frontend/components/*`
- `src/routes/*`

## Repository Structure

- `src/main.ts` — Main process entry point, window management, IPC handlers
- `src/preload.ts` — Preload script exposing `window.electronAPI` to renderer
- `src/index.tsx` — React app entry point
- `src/constants.ts` — Centralized constants and IPC event definitions
- `src/types.ts` — Central types for consistent data shapes between main and renderer
- `src/helpers.ts` — Utility helpers for common operations
- `src/backend/` — Backend file I/O and image processing:
  - `photos.ts` — Photo loading, thumbnail generation, and image manipulation
  - `projects.ts` — Project file operations and persistence
  - `menu.ts` — Application menu configuration
  - `recents.ts` — Recent projects tracking
- `src/frontend/` — React UI components and hooks:
  - `components/` — React components for UI elements
  - `hooks/` — Custom React hooks for UI logic
- `src/routes/` — TanStack Router route definitions (router generates `routeTree.gen.ts`)
- `src/models/` — Data model classes:
  - `Project.ts` — Project model
  - `Photo.ts` — Photo model
  - `Collection.ts` — Collection model
- `src/contexts/` — React Context providers (e.g., ProjectContext)
- `docs/` — User and technical documentation
- Tests: `*.test.ts` files co-located with source files
- Configuration: `tsconfig.json`, `vite.*.mts`, `forge.config.ts`, `vitest.config.ts`

## Considerations

- The app is often run on machines with limited hardware. Be conservative with memory and avoid loading many full-resolution images into memory at once.
- Favour streaming, thumbnails (`src/backend/photos.ts`), and on-disk edits over keeping large buffers in renderer memory. Use the backend helpers for file I/O and image processing (`sharp`).
- In React, avoid retaining large binary blobs in state across long sessions; prefer references to on-disk filenames and load File/ArrayBuffer only when needed (see `src/routes/edit.tsx` and `src/frontend/hooks/usePhotoEditor.ts`).

## Key Guidelines

1. **Always run tests before proposing changes**: Use `npm test` to verify linting, types, and unit tests pass
2. **Follow established patterns**: Examine similar code in the codebase before implementing new features
3. **Use IPC constants**: Always reference `IPC_EVENTS` from `src/constants.ts` instead of raw strings
4. **Maintain type safety**: Ensure all types are defined in `src/types.ts` and shared properly between main and renderer
5. **Keep the architecture clean**: Frontend calls preload helpers, main process handles file I/O, backend helpers do actual work
6. **Test new functionality**: Add or update unit tests alongside feature changes in `*.test.ts` files
7. **Document non-obvious code**: Add comments only for workarounds, hacks, or non-obvious logic paths
8. **Be mindful of performance**: Avoid loading large buffers into state; prefer references and lazy loading
