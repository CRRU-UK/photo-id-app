# Technical

Technical information, specifications, requirements, and user journeys.

## High-level architecture

- Main process: `src/main.ts` — app boot, `BrowserWindow` management, `ipcMain` handlers.
- Preload bridge: `src/preload.ts` — exposes `window.electronAPI` to renderer (use these methods from frontend).
- Renderer (UI): `src/index.tsx` and `src/frontend/**` — React + TanStack Router routes are generated into `src/routeTree.gen.ts` (do not edit).
- Backend helpers (file I/O, thumbnails, project logic): `src/backend/*.ts` called by the main process.

## Key files and patterns

- IPC event constants: `src/constants.ts` defines `IPC_EVENTS`. Use these names when linking main/preload/renderer behaviour.
- Preload API: call `window.electronAPI.*` from React. Example: `await window.electronAPI.savePhotoFile(data, arrayBuffer)` — handled in `src/main.ts` via `ipcMain.handle(IPC_EVENTS.SAVE_PHOTO_FILE, ...)`.
- Edit window flow: the main process opens edit windows by encoding JSON with `btoa` into the URL query (`?data=${btoa(JSON.stringify(data))}`) in `src/main.ts`; the edit route decodes with `atob` in `src/routes/edit.tsx`.
- Generated routes: `src/routeTree.gen.ts` is autogenerated by TanStack Router — do not modify it directly; edit files in `src/routes/` instead.
- Types: central types live in `src/types.ts` — use these for consistent shapes between main and renderer. Project-file types (`PhotoEdits`, `PhotoBody`, `CollectionBody`, `MatchedBody`, `ProjectBody`) are derived from Zod schemas in `src/schemas.ts` via `z.infer<>`.
- Schema validation: `src/schemas.ts` defines Zod schemas for project data. Project files are validated against these schemas on load via `parseProjectFile` in `src/backend/projects.ts`.

## Repository Structure

- `src/main.ts` — Main process entry point, window management, IPC handlers
- `src/preload.ts` — Preload script exposing `window.electronAPI` to renderer
- `src/index.tsx` — React app entry point
- `src/constants.ts` — Centralized constants and IPC event definitions
- `src/types.ts` — Central types for consistent data shapes between main and renderer
- `src/schemas.ts` — Zod schemas for project-file data; types in `src/types.ts` are derived from these
- `src/helpers.ts` — Utility helpers for common operations
- `src/backend/` — Backend file I/O and image processing:
  - `photos.ts` — Photo loading, thumbnail generation, and image manipulation
  - `projects.ts` — Project file operations and persistence
  - `menu.ts` — Application menu configuration
  - `recents.ts` — Recent projects tracking
- `src/frontend/` — React UI components and hooks:
  - `components/` — React components for UI elements
    - `ImageEditor.tsx` — Main photo editing layout and controls
  - `hooks/` — Custom React hooks for UI logic:
    - `useImageEditor.ts` — Composes image editor behaviour for the main canvas (zoom, pan, filters, export)
    - `imageEditor/` — Feature-focused hooks used by `useImageEditor`:
      - `useImageLoader.ts` — Load the current image `File` into an `HTMLImageElement` and expose a loaded flag
      - `useImageFilters.ts` — Manage filter state (`ImageFilters` in `src/types.ts`) for brightness, contrast, saturation, and edge detection
      - `useImageTransform.ts` — Manage zoom/pan transform state (`ImageTransformations` in `src/types.ts`) and coordinate conversions
      - `useCanvasRenderer.ts` — Render the image onto the canvas with the current filters and transform (throttled for performance)
      - `usePanInteraction.ts` — Pointer handlers for panning the image on the canvas
      - `useZoomInteraction.ts` — Wheel and button handlers for zooming while keeping the cursor location stable
- `src/routes/` — TanStack Router route definitions (router generates `routeTree.gen.ts`)
- `src/models/` — Data model classes:
  - `Project.ts` — Project model
  - `Photo.ts` — Photo model
  - `Collection.ts` — Collection model
- `src/contexts/` — React Context providers (e.g., ProjectContext)
- `docs/` — User and technical documentation
- Tests: `*.test.ts` files co-located with source files
- Configuration: `tsconfig.json`, `vite.*.mts`, `forge.config.ts`, `vitest.config.ts`

## Specifications

The following describes the specifications and requirements of user journeys and flows, and is intended for end-to-end tests and coding agent context.

### General

- The Electron app uses only internal pages and URLs, therefore all behaviours and routes should be fully deterministic
- Query parameters are ONLY used in edit windows for loading photos
- Data handling (e.g. project and settings data) should be versioned and guarded against schemas, with migrations and fallbacks when needed
- All project data, stacks, thumbnails, and edit metadata are persisted via the backend (`photos.ts`, `projects.ts`) and accessed from the renderer only via `window.electronAPI` IPC calls
- The edit window URL always encodes its state via `?data=...` as base64 JSON - navigation between photos in an edit window must respect this contract
- Thumbnails are stored alongside `project.photoid` in `thumbnails/` (see `PROJECT_THUMBNAIL_DIRECTORY`), and saving edits must regenerate the relevant thumbnail
- Original photos used in projects should NEVER EVER be modified in ANY way (overwritten, edited, deleted, etc.)

### Windows

- There can only be ONE main window, which is created when the app starts
- Only ONE main window should be used for the application process - multiple main windows should NOT be used
- The main window should ONLY show the index (`/`) or project (`/project`) views
- A user can load a project, close it, and load another project (or the same one) in the main window without the app exiting
- The main window should show the window menu
- Edit windows should ONLY show the edit view (`/edit`)
- Edit windows are ONLY created from the main window
- Edit windows do NOT show the window menu
- There can be multiple edit windows
- Edit windows should NEVER show the project or index views
- The main window should NEVER be able to navigate to the photo editor view, and the edit windows should NEVER be able to navigate to the index or project view
- If a photo cannot be loaded in an edit window, it should show the error message and NOT redirect anywhere else
- Edit windows can be closed without the app exiting
- When a project is closed (i.e. the user navigates from the project view to the index view), all of the edit windows should be automatically closed
- When the main window is closed or the app exits, all of the edit windows should also be closed
- When closing the project view with the keyboard shortcut, it should navigate to the index view instead of closing the window
- When closing the index view with the keyboard shortcut, it should close the window and application
- Restarting the app should NEVER load a project automatically, and instead show the index view instead
  - The exception to this is during development, i.e. hot-reload, should retain the project view if a project is already open
- DevTools should ONLY be shown during development, and NEVER shown in the production build
- Users should NEVER be able to refresh or modify the webview outside of the designed application flow

### Views

#### Index view

The index view is the default view when opening the app. It allows the user to:

- Start a new project in a folder
  - If a project file is already present, then it asks the user if they want to use it or overwrite it (reset it)
- Open an existing project file
- Open a project from recent projects
- Open the user guide documentation or changelog (based on the current tag) in an external browser
- Open the settings

##### Recent projects

- This shows a list of recent projects by last-opened date descending
- Last-opened is determined by the time when a project was last successfully opened in the project view
- If attempting to load a recent project leads to an error, then it should automatically be removed from the list
- Recent projects can be removed with the delete button - this only removes the project from the list, not the project file from disk
- If there are no recent projects, the list is not shown
- The recent project list has a maximum number of entries to show
- Recent projects are stored per user profile

##### Settings

- The settings overlay can be opened by clicking the settings button, with the keyboard shortcut, or from the window menu
- The settings overlay can also be opened from the project view with the keyboard shortcut or window menu
- The application theme can be changed from the settings
  - Theme changes propagate and affect all windows
- Telemetry (frontend and backend) can be changed from the settings
  - This setting requires an application restart due to being integrated into the Node process and cannot be toggled in runtime
- Changing a field value should automatically update the settings in both the frontend and backend, unless otherwise stated
- Settings should use default values on new installations
- Settings should persist between sessions
- ONLY the main window should have the settings overlay - edit windows should NEVER display the settings overlay
- Opening the settings overlay with the keyboard shortcut should focus the main window
- Settings are global app settings and not related to project data files
- Settings are stored per user

### Project View

The project view is accessed when opening a project. It allows the user to:

- Organise photos into various stacks
- Open a photo in the photo editor
- Export matches
  - Exporting matches should automatically open and focus the export folder after exported photos have been generated
- Change number of columns
  - The value is retained in state and not intended to be saved as a session
- Close the project (and navigate back to the index view)

#### Stacks

- Stacks contain one or more photographs
- Photos can be navigated between with the previous and next buttons
- A photo edit window can be opened with a button using the currently shown photo or by double clicking on the thumbnail
- Photos are moved between stacks by clicking and dragging a photo from one stack to another
  - Dragging a photo into a non-stack target has no effect
  - A stack is highlighted with a coloured border when a photo has been dragged over its drop zone
  - Any photo can be duplicated from and onto any stack, including the original stack
  - Duplicated photos should be fully independent from the original
- Photos can be duplicated by clicking and dragging the photo to another stack while pressing the keyboard shortcut
  - Duplicating a photo copies the data in the project data file into a new entry
- A user can click a button below the stack to reset the currently shown photo back to its original state (i.e. without any edits applied)
- There are three main stacks in a project, described below
- A photo can only ever exist in one stack at any one time - it should NOT exist in multiple stacks at once

##### Unassigned

- In new projects all photos are added to this stack
- The user can then move photos from the unassigned stack to others
- A progress bar below this stack shows how many photos have yet to be assigned
  - This progress bar should show how many photos have been moved out of the unassigned stack, regardless if they've been matched or discarded
- Photos in the unassigned stack are never exported
- There is ONLY one unassigned stack

##### Discarded

- Photos can be moved into the discarded stack if they are not going to be used (i.e. have no identifiable marks or are of low quality)
- Photos in the discarded stack are never exported
- There is ONLY one discarded stack

##### Matched

- Photos can be moved into matched stacks when they contain identifiable marks
- Matched stacks contain a pair of stacks, one for the left (L) and right (R) side of the animal
  - A stack can still be exported with just one side populated (i.e. if no photos of the other side were taken)
- These sides can contain multiple photos of the same side of the animal
- An optional ID can be added that is used when exporting the images (e.g. "001L", "002L")
  - Omitting the ID uses the stack ID instead (e.g. "AL", "BR")
- All images in matched stacks are exported
- There are a set number of matched stacks - a user CANNOT add or remove matched stacks
- Matched stacks are displayed in chunks (pages), with pagination allowing the user to navigate between these chunks by clicking the page labels or by keyboard navigation
- A column toggle allows the user to view stacks by one or two stacks in a row by clicking the toggle

### Edit View

- The edit view allows users to view full-sized photos in a new window
- The user can make a variety of edits to the photo:
  - Brightness, contrast, saturation can be adjusted using the sliders
  - Zooming (which also crops the photo) can be done using the buttons, mousewheel, or keyboard shortcuts
    - The user can NOT zoom out further than the original photo dimensions
    - Zooming towards or away from an edge should constrain/clamp the photo within the canvas
    - There is no maximum level of zoom
  - Panning the image can be done using the buttons, clicking and dragging, or keyboard shortcuts
    - The user can NOT pan outside of the original photo dimensions
    - Panning towards an edge should constrain/clamp the photo within the canvas
- The image should ALWAYS maintain its natural aspect ratio, including on window/canvas element resizing
- These edits can be saved to a photo by using the save button or shortcut
- Re-opening a photo in the edit view should pre-populate its edit values, i.e. they should persist between edits and NOT compound on re-opening and re-editing the photo
- Resetting the edits should return all of the sliders back to their default
- An 'edge detection' toggle and slider is used for aiding in the identification of marks in a photo
  - It does NOT get used when saving or exporting photos, and is purely a 'cosmetic' filter
  - Edge detection values do NOT get saved in the project data and are ephemeral
- Saving a photo generates a new thumbnail that updates in the project view, and updates the edit data in the project
- Edit values are used when exporting images
- Edits can be reset by using the reset button or shortcut
  - Resetting the edits only resets the edits back to their defaults, and does NOT automatically save the photo
- Failure in saving a photo or regenerating its thumbnail should not be automatically retried, and should show an error

### Project Data

- The project data file (`project.photoid`) is the ONLY source of truth for project data
- `project.photoid` is the ONLY applicable project data format (JSON validated against the Zod schema in `src/schemas.ts`)
- The `.photoid` file extension is associated with the app (macOS and Linux) so users can open project files directly from the file system
- When opening a `.photoid` file while the app is already running with a project open, the current project is closed (including all edit windows) and the new project is loaded
- Project files are validated against the Zod schema on load; invalid files display an error dialogue with the validation error
- Resetting a project should reset ALL of the project state (including thumbnails, which should be removed and regenerated)
- Any changes made to a project (updating stacks, editing photos, etc.) should automatically update (i.e. auto-save) the data file, therefore there should never be any 'unsaved' data
- If a user has made edits to a photo but NOT saved them, then trying to close the window, close the project, or exit the application should show a confirmation dialogue allowing them to keep the app open or discard the changes
- Users cannot (currently) add or remove photos from a project after the project has been created
- Project data is created and managed by ONLY the app - while in theory a user can manually edit the `project.photoid` file, the app uses no external input when managing the data file
- Images on the file system are loaded via the custom `photo://` protocol in order to keep the Electron app secure - the protocol can be used either in HTML (e.g. image tags) or via HTTP requests (i.e. `fetch`)
